<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>STEMI Screening Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; background:#0e1217; color:#e6e6e6; margin:0; padding:2rem;}
    .wrap{max-width:900px; margin:0 auto;}
    h1{font-weight:700; letter-spacing:.2px}
    .card{background:#151a21; border:1px solid #222832; border-radius:16px; padding:24px; box-shadow:0 6px 20px rgba(0,0,0,.25)}
    .drop{border:2px dashed #334155; border-radius:12px; padding:24px; text-align:center; transition:.2s; background:#0f1420}
    .drop.drag{border-color:#60a5fa; background:#0b1322}
    input[type=file]{display:none}
    .btn{background:#2563eb; color:#fff; border:0; padding:10px 14px; border-radius:10px; font-weight:600; cursor:pointer}
    .row{display:flex; gap:16px; flex-wrap:wrap; align-items:flex-start}
    pre{background:#0b1020; border:1px solid #1f2937; color:#a7f3d0; padding:12px; border-radius:12px; overflow:auto; max-height:420px}
    small{color:#9ca3af}
    .stemi-card{background:linear-gradient(135deg,#1e293b 0%,#0b1322 100%); border:1px solid #334155; border-radius:16px; padding:18px 20px}
    .stemi-badge{display:inline-block; font-size:12px; letter-spacing:.12em; font-weight:800; color:#fecaca; background:#7f1d1d; border:1px solid #ef4444; padding:6px 10px; border-radius:999px; margin-bottom:10px}
    .stemi-title{font-size:22px; font-weight:800; color:#ffffff; margin:4px 0 2px 0}
    .stemi-sub{font-size:14px; color:#cbd5e1; margin-bottom:8px}
    .stemi-meta{font-size:12px; color:#94a3b8}
    .non-card{background:linear-gradient(135deg,#0f172a 0%, #0b1020 100%); border:1px solid #293043; border-radius:16px; padding:16px 18px}
    .non-badge{display:inline-block; font-size:12px; letter-spacing:.12em; font-weight:800; color:#bbf7d0; background:#064e3b; border:1px solid #10b981; padding:6px 10px; border-radius:999px; margin-bottom:10px}
    .non-title{font-size:20px; font-weight:800; color:#e2e8f0; margin:4px 0 2px 0}
    .non-sub{font-size:14px; color:#cbd5e1; margin-bottom:4px}
    .non-meta{font-size:12px; color:#94a3b8}
    .tools{display:flex; gap:10px; align-items:center; margin-top:12px}
    .btn-ghost{background:#0f1420; color:#e5e7eb; border:1px solid #334155; padding:8px 12px; border-radius:10px; font-weight:600; cursor:pointer}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>STEMI Screening</h1>
    <p>Upload a 12-lead ECG image.</p>

    <div class="card">
      <div id="drop" class="drop">
        <p><strong>Drop ECG image here</strong> or</p>
        <label class="btn">
          Choose File<input id="file" type="file" accept="image/*"/>
        </label>
        <div><small>Accepted: JPG/PNG.</small></div>
      </div>

      <div class="row" style="margin-top:18px">
        <button id="send" class="btn">Classify</button>
        <small id="hint">Status: idle</small>
      </div>

      <!-- STEMI Result Card (hidden until STEMI) -->
      <div id="stemiCard" class="stemi-card" style="display:none; margin-top:18px;">
        <div class="stemi-badge">STEMI DETECTED</div>
        <div class="stemi-title" id="stemiTitle">STEMI</div>
        <div class="stemi-sub" id="stemiSub"></div>
        <div class="stemi-meta" id="stemiMeta"></div>
      </div>

      <!-- Non‑STEMI Result Card (shown when Non‑STEMI) -->
      <div id="nonCard" class="non-card" style="display:none; margin-top:18px;">
        <div class="non-badge">NON‑STEMI</div>
        <div class="non-title" id="nonTitle">Non‑STEMI</div>
        <div class="non-sub" id="nonSub"></div>
        <div class="non-meta" id="nonMeta"></div>
      </div>

      <!-- (Optional) Raw JSON for debugging; kept hidden by default -->
      <pre id="out" style="display:none;">{ }</pre>
    </div>
  </div>

  <script>
    const drop = document.getElementById('drop');
    const fileInput = document.getElementById('file');
    const btn = document.getElementById('send');
    const out = document.getElementById('out');
    const hint = document.getElementById('hint');
    const card = document.getElementById('stemiCard');
    const title = document.getElementById('stemiTitle');
    const sub = document.getElementById('stemiSub');
    const meta = document.getElementById('stemiMeta');
    const nonCard = document.getElementById('nonCard');
    const nonTitle = document.getElementById('nonTitle');
    const nonSub = document.getElementById('nonSub');
    const nonMeta = document.getElementById('nonMeta');
    const copyHint = document.getElementById('copyHint');
    let fileBlob = null;


    const setStatus = (t) => hint.textContent = "Status: " + t;

    const onFiles = (files) => {
      if (!files || !files.length) return;
      fileBlob = files[0];
      setStatus(`ready: ${fileBlob.name} (${Math.round(fileBlob.size/1024)} KB)`);
    };

    drop.addEventListener('dragover', e => { e.preventDefault(); drop.classList.add('drag'); });
    drop.addEventListener('dragleave', e => { e.preventDefault(); drop.classList.remove('drag'); });
    drop.addEventListener('drop', e => {
      e.preventDefault(); drop.classList.remove('drag');
      onFiles(e.dataTransfer.files);
    });

    fileInput.addEventListener('change', e => onFiles(e.target.files));

    function fmtProb(v){ try { return (Number(v)||0).toFixed(3); } catch(e){ return '0.000'; } }

    btn.addEventListener('click', async () => {
      if (!fileBlob) { setStatus("no file"); return; }
      setStatus("uploading...");
      card.style.display = 'none';
      nonCard.style.display = 'none';
      const fd = new FormData();
      fd.append('file', fileBlob);

      try {
        const res = await fetch('/classify', { method:'POST', body: fd });
        const text = await res.text();
        let json;
        try { json = JSON.parse(text); } catch { json = { error: text, status: res.status }; }
        // Keep raw hidden
        out.textContent = JSON.stringify(json, null, 2);

        if (!res.ok || !json || !json.decision) {
          setStatus('failed');
          nonCard.style.display = 'block';
          nonTitle.textContent = 'Non‑STEMI';
          nonSub.textContent = 'Request failed.';
          nonMeta.textContent = '';
          return;
        }

        const decision = String(json.decision || '').trim();
        // Show card ONLY when decision starts with "STEMI"
        if (decision.toUpperCase().startsWith('STEMI')) {
          // Always show big title "STEMI"
          title.textContent = 'STEMI';

          // Decide the STEMI subtype (STE-C vs STE-U)
          // 1) Try to parse from decision text if present
          let subtype = null;
          const m = decision.match(/(STE-[CU])/i);
          if (m) subtype = m[1].toUpperCase();

          // 2) Otherwise, infer from five_class_probs
          if (!subtype) {
            const fc = (json.five_class_probs || json.five_class || {});
            const pC2 = Number(fc['STE-C'] || 0);
            const pU2 = Number(fc['STE-U'] || 0);
            subtype = (pC2 >= pU2) ? 'STE-C' : 'STE-U';
          }

          // Optional artery and C/U probabilities from details, fallback to five_class_probs
          const d = json.details || {};
          const artery = d.artery || d.artery_raw || null;
          const pC = (d['p_STE-C'] != null) ? d['p_STE-C'] : ((json.five_class_probs||{})['STE-C']);
          const pU = (d['p_STE-U'] != null) ? d['p_STE-U'] : ((json.five_class_probs||{})['STE-U']);

          // Build subtitle lines
          const parts = [];
          parts.push(`Type: ${subtype}`);
          if (artery) parts.push(`Artery: ${artery}`);
          if (pC != null || pU != null) parts.push(`STE-C: ${fmtProb(pC)}  |  STE-U: ${fmtProb(pU)}`);
          sub.textContent = parts.join('   •   ');

          nonMeta.textContent = '';

          // Removed meta line and its references
          /*
          const pBin = (json.details && (json.details.P_STEMI || json.details.P_STEMI_bin))
                        || (json.binary_probs && (json.binary_probs['STEMI']));
          const filename = json.image || (fileBlob && fileBlob.name) || 'uploaded_ecg';
          meta.textContent = `File: ${filename}    ·    P(STEMI): ${fmtProb(pBin)}`;
          */
          card.style.display = 'block';
          nonCard.style.display = 'none';
          setStatus('done');
        } else {
          // Show Non‑STEMI card with subtype (Normal / Abnormal / STE‑Mimic)
          nonTitle.textContent = 'Non‑STEMI';

          // Try to parse subtype from decision string first, e.g., "Non‑STEMI (Normal)"
          let nonType = null;
          const m2 = decision.match(/\((Normal|Abnormal|STE-?Mimic)\)/i);
          if (m2) nonType = m2[1].replace(/STE-?Mimic/i, 'STE-Mimic');

          // Otherwise, infer from five_class_probs
          if (!nonType) {
            const fc = (json.five_class_probs || json.five_class || {});
            const cand = { 'Normal': Number(fc['Normal']||0), 'Abnormal': Number(fc['Abnormal']||0), 'STE-Mimic': Number((fc['STE-Mimic']||fc['STE_Mimic']||0)) };
            nonType = Object.entries(cand).sort((a,b)=>b[1]-a[1])[0][0];
          }

          nonSub.textContent = `Type: ${nonType}`;

          // Show three-class probabilities for Non‑STEMI
          const fc = (json.five_class_probs || json.five_class || {});
          const pN = Number(fc['Normal'] || 0);
          const pA = Number(fc['Abnormal'] || 0);
          const pM = Number(fc['STE-Mimic'] || fc['STE_Mimic'] || 0);
          nonMeta.textContent = `Normal: ${fmtProb(pN)}  |  Abnormal: ${fmtProb(pA)}  |  STE-Mimic: ${fmtProb(pM)}`;

          nonCard.style.display = 'block';
          card.style.display = 'none';
          setStatus('done');
        }
      } catch (err) {
        out.textContent = "Network error:\n" + err;
        setStatus('failed');
        card.style.display = 'none';
        nonCard.style.display = 'block';
        nonTitle.textContent = 'Non‑STEMI';
        nonSub.textContent = 'Network error';
        nonMeta.textContent = '';
      }
    });
  </script>
</body>
 </html>